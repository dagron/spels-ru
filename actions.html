<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd"> 
<html> 
  <head> 
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"> 
    <link href="css/style.css" type="text/css" rel="stylesheet"> 
    <link href="css/prettify.css" type="text/css" rel="stylesheet"> 
    <script type="text/javascript" src="js/prettify.js"></script> 
    <script type="text/javascript" src="js/lang-clojure.js"></script> 
    <title> 
      Casting SPELs with Clojure: Creating Special Actions in Our
      Game
    </title> 
  </head> 
  <body onLoad="prettyPrint()"> 
    <div class="main"> 
      <div class="top"> 
        <span class="pager"><a href="casting.html">&lt;&lt; first</a></span> 
        <span class="pager"><a href="spels.html">&lt; prev</a></span> 
        <span class="pager"><a href="casting.html">1</a></span> 
        <span class="pager"><a href="syntax.html">2</a></span> 
        <span class="pager"><a href="data.html">3</a></span> 
        <span class="pager"><a href="looking.html">4</a></span> 
        <span class="pager"><a href="walking.html">5</a></span> 
        <span class="pager"><a href="spels.html">6</a></span> 
        <span class="pager current">7</span> 
        <span class="pager"><a href="addendum.html">8</a></span> 
        <span class="pager"><a href="no_macros.html">9</a></span> 
        <span class="pager"><a href="addendum.html">next &gt;</a></span> 
        <span class="pager"><a href="no_macros.html">last &gt;&gt;</a></span> 
        <span class="pagertext">Creating Special Actions...</span> 
      </div> 
      <div class="heading">Creating Special Actions in Our Game</div> 
      <div class="textblock"> 
        <p> 
        We have only one more thing to do now and our game will
        be complete: Add some special actions to the game that
        the player has to do to win in the game. The first
        command will let the player weld the chain to the bucket
        in the attic:
        </p> 
        <pre class="prettyprint lang-clojure"> 
(def chain-welded false)
 
(defn weld [subject object]
  (cond (and (= location 'attic)
             (= subject 'chain)
             (= object 'bucket)
             (have? 'chain)
             (have? 'bucket)
             (not chain-welded))
        (do (def chain-welded true)
            '(the chain is now securely welded to the bucket -))
        :else '(you cannot weld like that -)))
        </pre> 
        <p> 
        So first we created a new global variable that lets us
        tell whether we've done this action already. Next, we
        create a weld function that makes sure all the right
        conditions are in place for welding and lets us weld.
        </p> 
      </div> 
      <img src="images/weld.jpg" alt="Welding"> 
      <div class="textblock"> 
        <p> 
        Let's try our new command:
        </p> 
        <pre class="prettyprint lang-clojure"> 
(weld 'chain 'bucket)</pre> 
        <pre class="console"> 
user=> (weld 'chain 'bucket)
(you cannot weld like that -)</pre> 
        <p> 
        Oops... we're don't have a bucket or chain, do we?
        ...and there's no welding machine around... oh well...
        </p> 
        <p> 
        Now let's create a command for dunking the chain and bucket in the well:
        </p> 
        <pre class="prettyprint lang-clojure"> 
(def bucket-filled false)
 
(defn dunk [subject object]
  (cond (and (= location 'garden)
             (= subject 'bucket)
             (= object 'well)
             (have? 'bucket)
             chain-welded)
        (do (def bucket-filled true)
            '(the bucket is now full of water))
        :else '(you cannot dunk like that -)))</pre> 
        <p> 
        Now if you paid attention, you probably noticed that this
        command looks <i>a lot</i> like the <code>weld</code> 
        command... Both commands need to check the location,
        subject, and object - But there's enough making them
        different enough so that we can't combine the
        similarities into a single function. Too bad...
        </p> 
        <p> 
        ...but since this is Lisp, we can do more than just
        write functions, we can cast SPELs! Let's create the
        following SPEL:
        </p> 
        <pre class="prettyprint lang-clojure"> 
(defspel game-action [command subj obj place & args]
  `(defspel ~command [subject# object#]
     `(spel-print (cond (and (= location '~'~place)
                             (= '~subject# '~'~subj)
                             (= '~object# '~'~obj)
                             (have? '~'~subj))
                        ~@'~args
                        :else '(i cannot ~'~command like that -)))))
      </pre> 
      </div> 
      <div class="textblock"> 
        <p> 
        Notice how ridiculously complex this SPEL is - It has
        more weird quotes, backquotes, commas and other weird
        symbols than you can shake a list at. More than that
        it is a SPEL that actually cast ANOTHER SPEL! Even experienced
        Lisp programmers would have to put some thought into
        create a monstrosity like this (and in fact they would
        consider this SPEL to be inelegant and would go through
        some extra esoteric steps to make it better-behaved
        that we won't worry about here...)
        </p> 
      </div> 
      <img src="images/game_action.jpg" alt="Game Action"> 
      <div class="textblock"> 
        <p> 
        The point of this SPEL is to show you just how
        sophisticated and clever you can get with these
        SPELs. Also, the ugliness doesn't really matter
        much if we only have to write it once and then
        can use it to make hundreds of commands for a
        bigger adventure game.
        </p> 
        <p> 
        Let's use our new SPEL to replace our ugly
        <code>weld</code> command:
        </p> 
        <pre class="prettyprint lang-clojure"> 
(game-action weld chain bucket attic
   (cond (and (have? 'bucket) (def chain-welded true))
              '(the chain is now securely welded to the bucket -)
         :else '(you do not have a bucket -)))
        </pre> 
        <p> 
        Look at how much easier it is to understand this
        command - The <code>game-action</code> SPEL lets us write exactly
        what we want to say without a lot of fat - It's almost
        like we've created our own computer language just for
        creating game commands. Creating your own pseudo-language
        with SPELs is called
        <b>Domain Specific Language Programming</b>, a very powerful
        way to program very quickly and elegantly.
        </p> 
        <pre class="prettyprint lang-clojure"> 
(weld chain bucket)</pre> 
        <pre class="console"> 
user=> (weld chain bucket)
(you do not have a chain -)</pre> 
        <p> 
        ...we still aren't in the right situation to do any welding, but the
        command is doing its job!
        </p> 
      </div> 
      <img src="images/dunk.jpg" alt="Dunking"> 
      <div class="textblock"> 
        <p> 
        Next, let's rewrite the <code>dunk</code> command as well:
        </p> 
        <pre class="prettyprint lang-clojure"> 
(game-action dunk bucket well garden
             (cond chain-welded 
                   (do (def bucket-filled true)
                       '(the bucket is now full of water))
                   :else '(the water level is too low to reach -)))
 
 
</pre> 
        <p> 
        Notice how the <code>weld</code> command had to
        check whether we <code>have?</code> the subject,
        but that the dunk command skips that step - Our
        new game-action SPEL makes the code easy to write
        and understand.
        </p> 
      </div> 
      <img src="images/splash.jpg" alt="Splash"> 
      <div class="textblock"> 
        <p> 
        And now our last code for splashing water on the wizard:
        </p> 
        <pre class="prettyprint lang-clojure"> 
(game-action splash bucket wizard living-room
             (cond (not bucket-filled) '(the bucket has nothing in it -)
                   (have? 'frog) '(the wizard awakens and sees that you stole
                                       his frog -
                                       he is so upset he banishes you to the
                                       netherworlds - you lose! the end -)
                   :else '(the wizard awakens from his slumber and greets you
                               warmly -
                               he hands you the magic low-carb donut - you win!
                               the end -)))
      </pre> 
      </div> 
      <img src="images/donut.jpg" alt="Getting the Donut"> 
      <div class="textblock"> 
        <p> 
        <b>You have now written a complete text adventure game!</b> 
        </p> 
        <p> 
        Click <a href="cheat.html">HERE</a> for a complete walkthrough
        of the game,
        </p> 
        <p> 
        Click <a href="code.html">HERE</a> for a copy of the source
        code you can copy &amp; paste into your Clojure prompt in a
        single step.
        </p> 
        <p> 
        In order to make this tutorial as simple as possible,
        many details about how Lisp works have been glossed
        or fudged over, so let's look at what those details are...
        </p> 
      </div> 
      <hr> 
      <div class="bottom"> 
        <span class="pager"><a href="casting.html">&lt;&lt; first</a></span> 
        <span class="pager"><a href="spels.html">&lt; prev</a></span> 
        <span class="pager"><a href="casting.html">1</a></span> 
        <span class="pager"><a href="syntax.html">2</a></span> 
        <span class="pager"><a href="data.html">3</a></span> 
        <span class="pager"><a href="looking.html">4</a></span> 
        <span class="pager"><a href="walking.html">5</a></span> 
        <span class="pager"><a href="spels.html">6</a></span> 
        <span class="pager current">7</span> 
        <span class="pager"><a href="addendum.html">8</a></span> 
        <span class="pager"><a href="no_macros.html">9</a></span> 
        <span class="pager"><a href="addendum.html">next &gt;</a></span> 
        <span class="pager"><a href="no_macros.html">last &gt;&gt;</a></span> 
        <span class="pagertext">Creating Special Actions...</span> 
      </div> 
    </div> 
  </body> 
</html> 
